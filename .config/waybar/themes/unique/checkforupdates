#!/bin/sh

# Check for internet connectivity
wget -q --spider https://www.google.com
if [ $? -ne 0 ]; then
    echo '{"text":"ERROR!", "tooltip":"No internet connection", "class":"error"}'
    exit 0
fi

# Fetch the raw list of updates
update_list=$(checkupdates)
count=$(echo "$update_list" | wc -l)

# If checkupdates returns an empty list, count will be 1 with a blank line; 
# we check if the string itself is empty.
if [ -z "$update_list" ]; then
    echo '{"text":"Fully Updated", "tooltip":"Your system is up to date", "class":"updated"}'
else
    # Format the tooltip: replace actual newlines with literal '\n' for JSON
    # We limit to the first 25 packages to prevent the tooltip from being too large
    tooltip_text=$(echo "$update_list" | head -n 25 | sed -z 's/\n/\\n/g')
    [ "$count" -gt 25 ] && tooltip_text="${tooltip_text}and more..."

    # Output JSON object Waybar expects
    echo "{\"text\":\"$count Updates\", \"tooltip\":\"$tooltip_text\", \"class\":\"pending\"}"
fi
